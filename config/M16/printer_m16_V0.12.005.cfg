# 该.cfg文件9月12号有针对M16 2号样机修改 - Leo 09/12/2024

[include mainsail.cfg]

# Accelerometer related code
[mcu rpi]
serial: /tmp/klipper_host_mcu

#[adxl345]
#cs_pin: rpi:None
#spi_bus: spidev0.0

#[resonance_tester]
#accel_chip: adxl345
#probe_points:
#    5, 5, 2

#[input_shaper]
#shaper_freq_x: 39.6
#shaper_type_x: mzv
## shaper_freq_y: 24.2
## shaper_type_y: mzv


#[include fiblaser.cfg]
[include pwmlaser.cfg]
#[include pwmtest.cfg]




[dooraction doorfun]
left_pin: !gpio12
#right_pin: !gpio15
opendoor_gcode:
   RESPOND TYPE=echo MSG='{"open:%d" % (0)}'
   {% if  (printer.print_stats.state == "printing" or printer.print_stats.state == "paused")   %}
     {% if printer.pause_resume.is_paused %}
       M118  st in paused   by event open door 
     {% else %}
       TPSW S=1
       PAUSE
     {% endif %}
   {% else %}
     M118 Idle state
   {% endif %}

closedoor_gcode:    
    RESPOND TYPE=echo MSG='{"close:%d" % (1)}'
   	{% if printer.pause_resume.is_paused %}
      M118  st in paused by event close door 
      TPSW S=0
      #RESUME
    {% else %}
      M118  st in not paused by event close door 
    {% endif %}


[limitswitch_check lswcheck]
x_min_pin: ^!hborad:gpio6
x_max_pin: !gpio14
y_min_pin: !gpio10
y_max_pin: !gpio11
z_min_pin: !gpio7
z_max_pin: !gpio13
press_gcode:
  RESPOND TYPE=echo MSG='{"lswpress:%d" % (0)}'
  M112
release_gcode:
  RESPOND TYPE=echo MSG='{"lswrelease:%d" % (0)}'



[zctrlpanel ctrlkey]
#up_pin: !gpio16
#down_pin: !gpio3
#up_pin:  !fboard:gpio20
#down_pin: !fboard:gpio21
up_pin:  ^!rpi:gpio2
down_pin: ^!rpi:gpio3
pshort_speed:5
plong_speed:10
#max_z_safe_d:100
max_z_safe_d:43
short_d_unit:1
long_d_unit:4
uppress_gcode:
    RESPOND TYPE=echo MSG='{"uppress:%d" % (0)}'
    {% if printer.pause_resume.is_paused  %}
      {% set doorobj = printer["dooraction doorfun"]|default({}) %}
      {% set doorst =   doorobj.isclose | default(0)|int != 0 %}
      {% if doorst  %}
          RESUME
      {% endif %}
    {% endif %}

uprelease_gcode:
    RESPOND TYPE=echo MSG='{"uprelease:%d" % (0)}'
uplngp_gcode:
    RESPOND TYPE=echo MSG='{"uplngp:%d" % (0)}'
uplngr_gcode:
    RESPOND TYPE=echo MSG='{"uplngr:%d" % (0)}'
downpress_gcode:
    RESPOND TYPE=echo MSG='{"dwonpress:%d" % (0)}'
    {% if printer.pause_resume.is_paused  %}
      {% set doorobj = printer["dooraction doorfun"]|default({}) %}
      {% set doorst =   doorobj.isclose | default(0)|int != 0 %}
      {% if doorst  %}
          RESUME
      {% endif %}
    {% endif %}    
downrelease_gcode:
    RESPOND TYPE=echo MSG='{"dwonrelease:%d" % (0)}'
downlngp_gcode:
    RESPOND TYPE=echo MSG='{"dwonlngp:%d" % (0)}'
downlngr_gcode:
    RESPOND TYPE=echo MSG='{"dwonlngr:%d" % (0)}'
abnormal_gcode: 
    RESPOND TYPE=echo MSG='{"abnormal:%d" % (0)}' 



#[gcode_button test_button_in]
#pin: ^!hboard:gpio6
#press_gcode:
    #RESPOND TYPE=echo MSG='{"press:%d" % (0)}'
#release_gcode:
    #RESPOND TYPE=echo MSG='{"release:%d" % (1)}'


[duplicate_pin_override]
pins:
    hborad:gpio6,gpio10,gpio7,gpio11,gpio13   
    

[idle_timeout]
timeout: 6
gcode:
  {% if printer.pause_resume.is_paused %}
    M118 Idle timeout while paused，Wait
  {% else %}
    M118 Idle timeout 
    M19
  {% endif %}
  {% set lsw = printer["limitswitch_check lswcheck"]|default({}) %}
  M118 x_min:{lsw.x_min|default("n")} x_max:{lsw.x_max|default("n")} 


[gcode_macro HPRESET]  
variable_runflag: 1
gcode:
  {% if runflag > 0 %} 
   OPEN_LSWCHECK E=0
   G32   X0
   G32   Y0
   G32   Z0
   M400
   G1  X1 Y1 
   G1  Z1
   M400
   OPEN_LSWCHECK E=5 #xy
   #OPEN_LSWCHECK E=1 #xyz
   M400
  {% else %}  
   OPEN_LSWCHECK E=0 #xy
  {% endif %}

  
[delayed_gcode poweron_once]
initial_duration: 1.          #printer is ready
gcode:
 M118 power on
 HPRESET
 G28


[gcode_macro MP_START]
gcode:
    UPDATE_DELAYED_GCODE ID=delay60s  DURATION=0  
    UPDATE_DELAYED_GCODE ID=delay120s  DURATION=0 
    

[gcode_macro MP_STOP]
gcode:
    UPDATE_DELAYED_GCODE ID=delay60s  DURATION=60 
    UPDATE_DELAYED_GCODE ID=delay120s  DURATION=120


[delayed_gcode delay60s]
gcode:
    M118 dealy60second

        
[delayed_gcode delay120s]
gcode:  
    M118 dealy120second




#[gcode_button test_button]
#pin: ^!gpio10
#press_gcode:
    #RESPOND TYPE=echo MSG='{"pressYMIN:%d" % (0)}'
#release_gcode:
    #RESPOND TYPE=echo MSG='{"releaseYMIN:%d" % (1)}'


#[duplicate_pin_override]
#pins:
    #gpio10        

[gcode_macro M7]
gcode:
    {% set S = params.S|default(0.0)|int %}
    SET_PIN PIN=air_dvr36 VALUE={S/1000.0}

[gcode_macro M8]
gcode:
    SET_PIN PIN=air_dvr36 VALUE=0


[output_pin air_dvr36]
pin: gpio0
#pin: gpio16
pwm: True
hardware_pwm: True
cycle_time: 0.001
value: 0
shutdown_value: 0


[gcode_macro TAIR]
gcode:
  {% set lp_count = 100000 %}
  {% for lp in range(lp_count) %}
    M7 S1000
    G4 P13000
    M8
    G4 P2000
    RESPOND TYPE=echo MSG='{"count:%d" % (lp)}'
  {% endfor %}



[gcode_macro STE_Y]
gcode:
    DUMP_TMC STEPPER=stepper_y   

[gcode_macro STE_X]
gcode:
    DUMP_TMC STEPPER=stepper_x
    

[stepper_x]
step_pin: gpio18
dir_pin: gpio17
enable_pin: !gpio16
microsteps: 16
rotation_distance: 40
endstop_pin: ^!hborad:gpio6
position_endstop: 0
position_max: 613
homing_speed: 50
position_min:-613
homing_positive_dir: false

[tmc2240 stepper_x]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 7
run_current:2.0
interpolate: True

[stepper_y]
step_pin: gpio21
dir_pin: gpio20
enable_pin: !gpio19
microsteps: 16
rotation_distance: 40
endstop_pin: ^!gpio10
position_endstop: 0
position_max: 410
homing_speed: 50
position_min:-410
homing_positive_dir: false

[tmc2240 stepper_y]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 4
run_current: 2.0
interpolate: True

[stepper_z]
step_pin: gpio23
dir_pin: !gpio22
enable_pin: !gpio24
microsteps: 16
rotation_distance: 2
#endstop_pin: ^!gpio7
endstop_pin: ^!gpio13
position_endstop: 0.0
position_max: 100

[tmc2209 stepper_z]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 1
run_current: 1.2

[stepper_a]
step_pin: gpio26
dir_pin: gpio25
enable_pin: !gpio27
microsteps: 16
rotation_distance: 8
endstop_pin: ^!gpio11
position_endstop: 0.0
position_max: 500

[tmc2209 stepper_a]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 3
run_current: 0.8
stealthchop_threshold: 999999

#[duplicate_pin_override]
#pins: gpio25

[stepper_b]
step_pin: hborad:gpio7
dir_pin: hborad:gpio10
enable_pin: !hborad:gpio12
microsteps: 16
rotation_distance: 27.35
#endstop_pin: ^!hborad:gpio6
endstop_pin: ^!hborad:gpio18
position_endstop: 0
position_max: 116.8
homing_speed: 50
step_mvirtualmode: 1

[stepper_c]
step_pin: hborad:gpio11
dir_pin: hborad:gpio5
enable_pin: !hborad:gpio8
microsteps: 16
rotation_distance: 27.35
endstop_pin: ^!hborad:gpio19
position_endstop: 0
position_max: 116.8
homing_speed: 50
step_mvirtualmode: 1

[galvo_config  xy2_100]
clkb_pin:hborad:gpio2
xyb_pin: hborad:gpio0
x_pos: 32767
y_pos: 32767
coord_factor: 3
mirror_type: 2

[homing_override]
gcode:
    #G90  
    SET_POS_GALVO X=0 Y=0
    #M400
    RESET_POS_GALVO_VIR
    #M400
    G90
    G1  B0 C0 F3000 
#   G28  X0
#   G1  X10
#axes:   zabc
axes: xyzabc
#axes: xzabc
#axes:  yzabc
set_position_x: 0
set_position_y: 0
set_position_z: 0
set_position_a: 0
set_position_b: 0
set_position_c: 0

[mcu]
#M14 serial: /dev/serial/by-id/usb-Klipper_rp2040_45474150540BF83A-if00
#serial: /dev/serial/by-id/usb-Klipper_rp2040_454741505A882BCA-if00
#serial:  /dev/serial/by-id/usb-Klipper_rp2040_E6635C469F22AC32-if00
#serial:  /dev/serial/by-id/usb-Klipper_rp2040_454741505B85E3AA-if00 
#serial:  /dev/serial/by-id/usb-Klipper_rp2040_E6632CA8A78F7138-if00 
serial:   /dev/serial/by-id/usb-Klipper_rp2040_E663386203867621-if00
#t#serial:    /dev/serial/by-id/usb-Klipper_rp2040_E6632CA8A78F7138-if00


[mcu hborad]
#serial: /dev/serial/by-id/usb-Klipper_rp2040_45474150540BF83A-if00
#serial: /dev/serial/by-id/usb-Klipper_rp2040_E66038B713399330-if00
#serial: /dev/serial/by-id/usb-Klipper_rp2040_E66368254F456427-if00
#serial:  /dev/serial/by-id/usb-Klipper_rp2040_E6635C469F22AC32-if00
serial:  /dev/serial/by-id/usb-Klipper_rp2040_E66368254F5C1C27-if00
#serial:  /dev/serial/by-id/usb-Klipper_rp2040_E6635C469F22AC32-if00
#t#serial:  /dev/serial/by-id/usb-Klipper_rp2040_E66368254F60C121-if00

#usb-Klipper_rp2040_454741505A882BCA-if00
#usb-Klipper_rp2040_E66038B713399330-if00

[printer]
kinematics: corexy_galvo
#kinematics: corexy
max_velocity: 2200
max_accel: 8000
#max_accel: 20000
max_z_velocity: 50
max_z_accel: 100
hradiation_angle: 0.35
focus_distance: 160
magnify_factor: 100
#powervary_mode: 0
#powervary_factor: 0.9
