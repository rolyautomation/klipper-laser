# 该.cfg文件9月12号有针对M16 2号样机修改 - Leo 09/12/2024
# 该.cfg文件2月26号有针对M16 bv4 - 02/26/2025

# Includes
[include mainsail.cfg]
# [include rollerset.cfg]
[include fiblaser_bv2_rf.cfg]
[include pwmlaserbv3rf.cfg]

#Accelerometer related code
[mcu rpi]
serial: /tmp/klipper_host_mcu

#[adxl345]
# cs_pin: hborad:gpio9
# spi_software_miso_pin: hborad:gpio8
# spi_software_mosi_pin: hborad:gpio11
# spi_software_sclk_pin: hborad:gpio10

# [resonance_tester]
# accel_chip: adxl345
# probe_points:
# 5, 5, 25

[input_shaper]
shaper_freq_x: 40
shaper_type_x: 2hump_ei
shaper_freq_y: 29
shaper_type_y: ei
shaper_freq_a: 39.2
shaper_type_a: mzv

[laserstore]
filename: ~/printer_data/config/laserparam.cfg

[laserctrl]

[temperature_sensor WATERTH0]
#sensor_type: ATC Semitec 104GT-2
#sensor_type: EPCOS 100K B57560G104F
sensor_type: Generic 3950 10k
sensor_pin: hborad:gpio26 # TH0
pullup_resistor: 4700

[dooraction doorfun]
left_pin: ^!gpio12
right_pin: ^!gpio14
opendoor_gcode:
   RESPOND TYPE=echo MSG='{"open:%d" % (0)}'
   {% if  (printer.print_stats.state == "printing" or printer.print_stats.state == "paused")   %}
     {% if printer.pause_resume.is_paused %}
       M118  st in paused   by event open door 
     {% else %}
       TPSW S=1
       PAUSE
     {% endif %}
   {% else %}
     M118 Idle state
   {% endif %}

closedoor_gcode:    
    RESPOND TYPE=echo MSG='{"close:%d" % (1)}'
   	{% if printer.pause_resume.is_paused %}
      M118  st in paused by event close door 
      TPSW S=0
      #RESUME
    {% else %}
      M118  st in not paused by event close door 
    {% endif %}

[limitswitch_check lswcheck]
#x_min_pin: ^!hborad:gpio6
x_min_pin: ^!gpio5
x_max_pin: ^!gpio2
y_min_pin: ^!gpio6
y_max_pin: ^!gpio4
#z_min_pin: ^!gpio13
#z_max_pin: ^!gpio15
z_min_pin: ^!gpio15
z_max_pin: ^!gpio13
#z_max_pin: ^!gpio13
press_gcode:
  RESPOND TYPE=echo MSG='{"lswpress:%d" % (0)}'
  M112
release_gcode:
  RESPOND TYPE=echo MSG='{"lswrelease:%d" % (0)}'

[zctrlpanel ctrlkey]
up_pin: !gpio10
down_pin: !gpio11
#up_pin:  !fboard:gpio20
#down_pin: !fboard:gpio21
#up_pin:  ^!rpi:gpio2
#down_pin: ^!rpi:gpio3
pshort_speed:5
plong_speed:10
#max_z_safe_d:100
#max_z_safe_d:50
max_z_safe_d:45
short_d_unit:1
long_d_unit:4
uppress_gcode:
    RESPOND TYPE=echo MSG='{"uppress:%d" % (0)}'
    {% if printer.pause_resume.is_paused  %}
      {% set doorobj = printer["dooraction doorfun"]|default({}) %}
      {% set doorst =   doorobj.isclose | default(0)|int != 0 %}
      {% if doorst  %}
          RESUME
      {% endif %}
    {% endif %}

uprelease_gcode:
    RESPOND TYPE=echo MSG='{"uprelease:%d" % (0)}'
uplngp_gcode:
    RESPOND TYPE=echo MSG='{"uplngp:%d" % (0)}'
uplngr_gcode:
    RESPOND TYPE=echo MSG='{"uplngr:%d" % (0)}'
downpress_gcode:
    RESPOND TYPE=echo MSG='{"dwonpress:%d" % (0)}'
    {% if printer.pause_resume.is_paused  %}
      {% set doorobj = printer["dooraction doorfun"]|default({}) %}
      {% set doorst =   doorobj.isclose | default(0)|int != 0 %}
      {% if doorst  %}
          RESUME
      {% endif %}
    {% endif %}    
downrelease_gcode:
    RESPOND TYPE=echo MSG='{"dwonrelease:%d" % (0)}'
downlngp_gcode:
    RESPOND TYPE=echo MSG='{"dwonlngp:%d" % (0)}'
downlngr_gcode:
    RESPOND TYPE=echo MSG='{"dwonlngr:%d" % (0)}'
abnormal_gcode: 
    RESPOND TYPE=echo MSG='{"abnormal:%d" % (0)}' 

#[jogging jogrun]  
#jog_pin: ^!rollerset:gpio3
#jog_pin: ^!rollerset:gpio16
#jog_pin: ^!rpi:gpio24

#[jogtrigger jogrun]  
#trig_pin: 23

#[fastdigitalout mcujogout]  
#ctrl_pin: rpi:gpio25
#ctrl_pin: rollerset:gpio24
#ctrl_pin: rpi:gpio23

#[gcode_button test_button_in]
#pin: ^!hboard:gpio6
#press_gcode:
    #RESPOND TYPE=echo MSG='{"press:%d" % (0)}'
#release_gcode:
    #RESPOND TYPE=echo MSG='{"release:%d" % (1)}'

[duplicate_pin_override]
pins:
    gpio5,gpio6,gpio13,gpio15  
    #hborad:gpio6,gpio10,gpio7,gpio11,gpio13,gpio3,gpio15  

[idle_timeout]
timeout: 6
gcode:
  {% if printer.pause_resume.is_paused %}
    M118 Idle timeout while paused，Wait
  {% else %}
    M118 Idle timeout 
    M19
  {% endif %}
  {% set lsw = printer["limitswitch_check lswcheck"]|default({}) %}
  M118 x_min:{lsw.x_min|default("n")} x_max:{lsw.x_max|default("n")} 

[gcode_macro HPRESET]  
variable_runflag: 0
gcode:
  {% if runflag > 0 %} 
   OPEN_LSWCHECK E=0
   G32   X0
   G32   Y0
   G32   Z0
   M400
   G1  X1 Y1 
   G1  Z1
   M400
   OPEN_LSWCHECK E=5 #xy
   #OPEN_LSWCHECK E=1 #xyz
   M400
  {% else %}  
   OPEN_LSWCHECK E=0 #xy
  {% endif %}

[gcode_macro HPRESET]  
variable_runflag: 0
gcode:
  {% if runflag > 0 %} 
   OPEN_LSWCHECK E=0
   G32   X0
   G32   Y0
   G32   Z0
   M400
   G1  X1 Y1 
   G1  Z1
   M400
   OPEN_LSWCHECK E=5 #xy
   #OPEN_LSWCHECK E=1 #xyz
   M400
  {% else %}  
   OPEN_LSWCHECK E=0 #xy
  {% endif %}

[gcode_macro OFFSETXY] 
gcode:
   M400
   G1  X{printer["gcode_macro MACH_PARAM"].offset_x}  Y{printer["gcode_macro MACH_PARAM"].offset_y}  F{printer["gcode_macro MACH_PARAM"].offmove_speed} 
   M400
   G28

[gcode_macro HHOME]  
variable_runflag: 1
gcode:
  {% if runflag > 0 %} 
   OPEN_LSWCHECK E=0
   G32 X
   G32 Y
   #G32   Z0
   M400
   G1 X{printer["gcode_macro MACH_PARAM"].offset_x}  Y{printer["gcode_macro MACH_PARAM"].offset_y}  F{printer["gcode_macro MACH_PARAM"].offmove_speed} 
   #G1  X1 Y1 
   #G1  Z1
   M400
   #OPEN_LSWCHECK E=5 #xy
   #OPEN_LSWCHECK E=1 #xyz
   M400
   G28
  {% else %}  
   OPEN_LSWCHECK E=0 #xy
  {% endif %}

[delayed_gcode poweron_once]
initial_duration: 1.          #printer is ready
gcode:
 M118 power on
 HPRESET
 G28
 OPEN_FIBERPOWER
 #SET_PIN PIN=smokefan VALUE=0.2

# Various PWM controls for auxilliary functions
[output_pin radiator_fan]
pin: gpio25
pwm: True
hardware_pwm: True
cycle_time: 0.001
value: 0
shutdown_value: 0

[output_pin exhaust_fan]
pin: gpio1
pwm: True
hardware_pwm: True
cycle_time: 0.001
value: 0
shutdown_value: 0

[output_pin water_pump]
pin: gpio7
pwm: True
hardware_pwm: True
cycle_time: 0.001
value: 0
shutdown_value: 0

[output_pin red_dot_fiber]
pin: gpio3
pwm: True
hardware_pwm: True
cycle_time: 0.001
value: 1
shutdown_value: 0

# Air assist controls
[gcode_macro M7]
gcode:
    {% set S = params.S|default(800.0)|int %}
    SET_PIN PIN=air_dvr36 VALUE={S/1000.0}

[gcode_macro M8]
gcode:
    {% set S = params.S|default(800.0)|int %}
    SET_PIN PIN=air_dvr36 VALUE={S/1000.0}    

[gcode_macro M9]
gcode:
    SET_PIN PIN=air_dvr36 VALUE=0    

[output_pin air_dvr36]
pin: gpio0
pwm: True
hardware_pwm: True
cycle_time: 0.001
value: 0
shutdown_value: 0

# Swing arm controls
[gcode_macro M510]
gcode:
    {% set anglem = printer["angledcmove as5600m"] %}
    {% if anglem.sarm_cpos > 0 %}
      M118  repeatcmd,workingmode 
    {% else %}
      M118  workingmode  
      M400
      SWINGARM_WAITM M=0
      SWINGARM_BYAS  P=1  
      SWINGARM_WAITM M=1
      M400    
    {% endif %}

[gcode_macro M511]
gcode:
    {% set anglem = printer["angledcmove as5600m"] %}
    {% if anglem.sarm_cpos == 0 %}
      M118  repeatcmd,homemode 
    {% else %}    
      M118  homemode    
      M400  
      SWINGARM_WAITM M=0    
      SWINGARM_BYAS  P=0 
      SWINGARM_WAITM M=1
      M400 
    {% endif %}    
    

[gcode_macro M603]
gcode:
    {% set S = params.S|default(0.0)|int %}
    SET_PIN PIN=smokefan VALUE={S/1000.0}

[gcode_macro MP_START]
gcode:
    UPDATE_DELAYED_GCODE ID=delay60s  DURATION=0  
    UPDATE_DELAYED_GCODE ID=delay120s  DURATION=0
    SET_PIN PIN=smokefan VALUE=1
    
[gcode_macro MP_STOP]
gcode:
    UPDATE_DELAYED_GCODE ID=delay60s  DURATION=60 
    UPDATE_DELAYED_GCODE ID=delay120s  DURATION=120
    SET_PIN PIN=smokefan VALUE=0.2
    
[delayed_gcode delay60s]
gcode:
    M118 dealy60second
    SET_PIN PIN=smokefan VALUE=0.2
        
[delayed_gcode delay120s]
gcode:  
    M118 dealy120second

[gcode_macro BH_START]
gcode:
    UPDATE_DELAYED_GCODE ID=delaybh  DURATION=0  
    M118 close delaybh and start work
    SET_PIN PIN=water_pump VALUE=1
    SET_PIN PIN=radiator_fan VALUE=1
    
[gcode_macro BH_STOP]
gcode:
    UPDATE_DELAYED_GCODE ID=delaybh  DURATION={printer["gcode_macro MACH_PARAM"].delay_bhd} 
    M118 set delaybh {printer["gcode_macro MACH_PARAM"].delay_bhd}  and stop work

[delayed_gcode delaybh]
gcode:
    M118 delaybh finish
    SET_PIN PIN=water_pump VALUE=0
    SET_PIN PIN=radiator_fan VALUE=0      

[gcode_macro TAIR]
gcode:
  {% set lp_count = 100000 %}
  {% for lp in range(lp_count) %}
    M7 S1000
    G4 P13000
    M8
    G4 P2000
    RESPOND TYPE=echo MSG='{"count:%d" % (lp)}'
  {% endfor %}

[gcode_macro STE_Y]
gcode:
    DUMP_TMC STEPPER=stepper_y   

[gcode_macro STE_X]
gcode:
    DUMP_TMC STEPPER=stepper_x
    
# Stepper information
[stepper_x]
step_pin: gpio22
dir_pin: gpio23
enable_pin: !gpio24
microsteps: 16
rotation_distance: 40
endstop_pin: ^!gpio5
position_endstop: -2.0
position_max: 613
homing_speed: 50
position_min:-613
homing_positive_dir: false

[tmc2240 stepper_x]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 7
run_current: 1.8
interpolate: True

[stepper_y]
step_pin: gpio19
dir_pin: gpio20
enable_pin: !gpio21
microsteps: 16
rotation_distance: 40
endstop_pin: ^!gpio6
position_endstop: -3.0
position_max: 410
homing_speed: 50
position_min:-410
homing_positive_dir: false

[tmc2240 stepper_y]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 4
run_current: 1.8
interpolate: True

[stepper_z]
step_pin: gpio17
dir_pin: !gpio18
enable_pin: !gpio16
microsteps: 16
rotation_distance: 4
endstop_pin: ^!gpio13
position_endstop: 52.5
position_max: 52.5

[tmc2209 stepper_z]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 1
run_current: 1.2

# Placeholder for when roller.cfg is not included, so that we are not missing a stepper
[stepper_a]
step_pin: gpio26
dir_pin: gpio32
enable_pin: !gpio27
microsteps: 16
rotation_distance: 8
endstop_pin: ^!gpio15
position_endstop: 0.0
position_max: 500

[stepper_b]
step_pin: hborad:gpio4
dir_pin: hborad:gpio5
enable_pin: !hborad:gpio22
microsteps: 16
rotation_distance: 27.35
#endstop_pin: ^!hborad:gpio6
#endstop_pin: ^!hborad:gpio7
endstop_pin: ^!hborad:gpio20
position_endstop: 0
position_max: 116.8
homing_speed: 50
step_mvirtualmode: 1

[stepper_c]
#step_pin: hborad:gpio8
step_pin: hborad:gpio12
dir_pin: hborad:gpio13
enable_pin: !hborad:gpio14
microsteps: 16
rotation_distance: 27.35
#endstop_pin: ^!hborad:gpio15
endstop_pin: ^!hborad:gpio21
position_endstop: 0
position_max: 116.8
homing_speed: 50
step_mvirtualmode: 1

[galvo_config  xy2_100]
clkb_pin:hborad:gpio2
xyb_pin: hborad:gpio0
x_pos: 32767
y_pos: 32767
coord_factor: 3
mirror_type: 2
stepper_list:stepper_b,stepper_c,extruderpwm,extruderpwm1

[homing_override]
gcode:
    #G90  
    SET_POS_GALVO X=0 Y=0
    #M400
    RESET_POS_GALVO_VIR
    #M400
    G90
    G0  B0 C0 F3000 
#   G28  X0
#   G1  X10
#axes:   zabc
axes: xyzabc
#axes: xzabc
#axes:  yzabc
set_position_x: 0
set_position_y: 0
#set_position_z: 50
#set_position_z: 25
set_position_z: 0
set_position_a: 0
set_position_b: 0
set_position_c: 0

[mcu]
serial: /dev/serial/by-id/usb-mmain_rp2040_E6646C858B224026-if00

[mcu hborad]
serial:  /dev/serial/by-id/usb-mgalvo_rp2040_E6646C858B96972A-if00

[printer]
kinematics: corexy_galvo
max_velocity: 3000
max_accel: 800000
max_z_velocity: 5
max_z_accel: 100
max_a_velocity: 50
max_a_accel: 500
max_m_velocity: 800
max_m_accel: 5000
mech_enable_alone: 1
square_corner_velocity: 5
minimum_cruise_ratio: 0.1
hradiation_angle: 0.35
focus_distance: 160
magnify_factor: 100
# Scale factor that relates to axes_r[6] for the virtual extruder
powervary_factor: 0.5

g0_speed_galvo: 500
g0_speed_xy: 200
g0_speed_a: 50

[gcode_macro MACH_PARAM]
#mm
variable_offset_x: 3.0
variable_offset_y: 3.0
#mm/min
variable_offmove_speed: 6000
#second
variable_delay_bhd: 60
gcode:



